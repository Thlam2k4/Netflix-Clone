version: 0.2
env:
  variables:
    AWS_REGION: "us-east-1"
    EKS_CLUSTER: "netflix-app-eks"
    ECR_REPO: "266735826560.dkr.ecr.us-east-1.amazonaws.com/devsecops/netflix-app"
    SONAR_HOST_URL: "http://34.232.189.92:9000"
    SONAR_PROJECT_KEY: "netflix-app"
    TRIVY_SERVER: "http://34.232.189.92:4954"
    # S·ª¨A L·ªñI UNZIP: D√πng phi√™n b·∫£n c·ª• th·ªÉ
    SONAR_SCANNER_VERSION: "5.0.1.3000"
    
    # C√ÅC BI·∫æN C·∫¶N THI·∫æT CHO GCP (Ph·∫£i ƒë∆∞·ª£c thi·∫øt l·∫≠p trong CodeBuild UI)
    GCP_REGION: "us-central1"
    GCP_ARTIFACT_HOST: "us-central1-docker.pkg.dev" # C·∫ßn kh·ªõp v·ªõi Artifact Registry
    GKE_CLUSTER: "netflix-app-gke"
    K8S_NAMESPACE: "default"
    # GCP_PROJECT (PLAIN TEXT)
    # GCP_SA_KEY_JSON (SECURE VARIABLE HO·∫∂C SECRETS MANAGER)

phases:
  install:
    commands:
      - echo "üîß Installing tools and dependencies..."
      - yum install -y jq unzip
      
      # FIX L·ªñI UNZIP: T·∫£i v√† c·∫•u h√¨nh sonar-scanner b·∫±ng version c·ª• th·ªÉ
      - echo "Installing Sonar Scanner version ${SONAR_SCANNER_VERSION}..."
      - curl -sL https://github.com/SonarSource/sonar-scanner-cli/releases/download/${SONAR_SCANNER_VERSION}/sonar-scanner-cli-${SONAR_SCANNER_VERSION}-linux.zip -o scanner.zip
      - unzip scanner.zip -d /opt/
      - mv /opt/sonar-scanner-${SONAR_SCANNER_VERSION}-linux /opt/sonar-scanner 
      - export PATH=$PATH:/opt/sonar-scanner/bin
      
      # Install Trivy client
      - curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
      
      # IaC security: tfsec & checkov
      - pip install --quiet checkov tfsec

  pre_build:
    commands:
      # 1. Login ECR
      - echo "üîê Logging into ECR..."
      - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REPO
      - TAG=${CODEBUILD_RESOLVED_SOURCE_VERSION}
      - echo "Using TAG = $TAG"

      # 2. X√ÅC TH·ª∞C V√Ä ƒêƒÇNG NH·∫¨P DOCKER V·ªöI GCP ARTIFACT REGISTRY (CHO MIRRORING)
      - if [ -n "$GCP_SA_KEY_JSON" ]; then
      - echo "Activating GCP Service Account and configuring Docker for Artifact Registry..."
      - printf '%s' "$GCP_SA_KEY_JSON" > /tmp/gcpkey.json
      - gcloud auth activate-service-account --key-file=/tmp/gcpkey.json
      - gcloud auth configure-docker $GCP_ARTIFACT_HOST --quiet
      - fi

  build:
    commands:
      - echo "üîç Running SonarQube scan..."
      # - sonar-scanner -Dsonar.projectKey=$SONAR_PROJECT_KEY -Dsonar.sources=. -Dsonar.host.url=$SONAR_HOST_URL -Dsonar.login=$SONAR_TOKEN
      
      - echo "üê≥ Building Docker image..."
      - docker build -t netflix-app:$TAG .
      - docker tag netflix-app:$TAG netflix-app:latest # Tag c·ª•c b·ªô ƒë·ªÉ scan

      - echo "üîé Scanning image via Trivy..."
      # K√≠ch ho·∫°t Trivy scan (s·∫Ω FAIL pipeline n·∫øu c√≥ HIGH/CRITICAL)
      - trivy image --exit-code 1 --severity HIGH,CRITICAL netflix-app:$TAG 

      - echo "üõ° Running IaC Security Scans..."
      # L∆∞u √Ω: S·∫Ω kh√¥ng fail build n·∫øu ch·ªâ c√≥ warning (do || true)
      - tfsec ./ || true 
      - checkov -d ./ || true
      
  post_build:
    commands:
      # 1. PUSH TO ECR (PRIMARY)
      - echo "üì§ Pushing image to ECR..."
      - docker tag netflix-app:$TAG ${ECR_REPO}:$TAG
      - docker push ${ECR_REPO}:$TAG
      - docker push ${ECR_REPO}:latest # ƒê·∫£m b·∫£o tag latest lu√¥n c·∫≠p nh·∫≠t

      # 2. MIRROR TO GCP ARTIFACT REGISTRY (STANDBY)
      - if [ -n "$GCP_SA_KEY_JSON" ]; then
      - echo "Mirroring image to GCP Artifact Registry..."
      - docker tag ${ECR_REPO}:$TAG ${GCP_ARTIFACT_HOST}/${GCP_PROJECT}/netflix-app:${TAG}
      - docker push ${GCP_ARTIFACT_HOST}/${GCP_PROJECT}/netflix-app:${TAG}
      - fi
      
      # 3. DEPLOY TO EKS (PRIMARY)
      - echo "üöÄ Deploying to EKS cluster (AWS Primary)..."
      - aws eks update-kubeconfig --region $AWS_REGION --name $EKS_CLUSTER
      - kubectl set image deployment/netflix-app netflix-container=${ECR_REPO}:$TAG 
      - kubectl rollout status deployment/netflix-app -n $K8S_NAMESPACE

      # 4. DEPLOY TO GKE (HOT STANDBY)
      - if [ -n "$GCP_SA_KEY_JSON" ]; then
      - echo "Deploying to GKE cluster (GCP Hot Standby)..."
      - gcloud container clusters get-credentials $GKE_CLUSTER --region $GCP_REGION --project $GCP_PROJECT
      - kubectl set image deployment/netflix-app netflix-app=${GCP_ARTIFACT_HOST}/${GCP_PROJECT}/netflix-app:${TAG}
      - kubectl rollout status deployment/netflix-app -n $K8S_NAMESPACE
      - fi
      
artifacts:
  files:
    - '**/*'
