version: 0.2

env:
  variables:
    AWS_REGION: "us-east-1"
    EKS_CLUSTER: "netflix-app-eks"
    ECR_REPO: "266735826560.dkr.ecr.us-east-1.amazonaws.com/devsecops/netflix-app"
    # SonarQube server c·ªßa b·∫°n
    SONAR_HOST_URL: "http://34.232.189.92:9000"
    SONAR_PROJECT_KEY: "netflix-app"
    # Trivy server c·ªßa b·∫°n
    TRIVY_SERVER: "http://34.232.189.92:4954"
    # ƒê·∫∑t phi√™n b·∫£n Sonar Scanner c·ª• th·ªÉ ƒë·ªÉ tr√°nh l·ªói t·∫£i v·ªÅ/unzip
    SONAR_SCANNER_VERSION: "5.0.1.3000" # <-- S·ª≠a ƒë·ªïi quan tr·ªçng
    # C·∫ßn thi·∫øt cho SonarQube n·∫øu kh√¥ng ph·∫£i Public
    # SONAR_TOKEN: "your_sonar_token"

phases:
  install:
    commands:
      - echo "üîß Installing tools..."
      - **yum install -y jq unzip** # ƒê·∫£m b·∫£o ƒë√£ c√†i
      
      # Install sonar-scanner - S·ª¨A L·ªñI UNZIP B·∫∞NG C√ÅCH D√ôNG VERSION C·ª§ TH·ªÇ
      - echo "Installing Sonar Scanner version ${SONAR_SCANNER_VERSION}..."
      - **curl -sL https://github.com/SonarSource/sonar-scanner-cli/releases/download/${SONAR_SCANNER_VERSION}/sonar-scanner-cli-${SONAR_SCANNER_VERSION}-linux.zip -o scanner.zip**
      - **unzip scanner.zip -d /opt/**
      - **mv /opt/sonar-scanner-${SONAR_SCANNER_VERSION}-linux /opt/sonar-scanner** # ƒê·ªïi t√™n cho d·ªÖ qu·∫£n l√Ω
      - **export PATH=$PATH:/opt/sonar-scanner/bin** # S·ª≠a ƒë∆∞·ªùng d·∫´n PATH
      
      # Install Trivy client
      - curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
      
      # IaC security: tfsec & checkov
      - pip install --quiet checkov
      - pip install --quiet tfsec

  pre_build:
    commands:
      - echo "üîê Logging into ECR..."
      - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REPO
      - TAG=${CODEBUILD_RESOLVED_SOURCE_VERSION}
      - echo "Using TAG = $TAG"

  build:
    commands:
      - echo "üîç Running SonarQube scan..."
      # B·ªè comment v√† ƒëi·ªÅn SONAR_TOKEN n·∫øu b·∫°n mu·ªën ch·∫°y Sonar Scan
      # - sonar-scanner \
      #    -Dsonar.projectKey=$SONAR_PROJECT_KEY \
      #    -Dsonar.sources=. \
      #    -Dsonar.host.url=$SONAR_HOST_URL \
      #    -Dsonar.login=$SONAR_TOKEN
      
      - echo "üê≥ Building Docker image..."
      - docker build -t netflix-app:$TAG .

      - echo "üîé Scanning image via Trivy Server ($TRIVY_SERVER)"
      # B·ªè comment ƒë·ªÉ ch·∫°y Trivy
      # - trivy client --remote $TRIVY_SERVER --exit-code 1 --severity HIGH,CRITICAL --debug netflix-app:$TAG

      - echo "üõ° Running IaC Security Scans..."
      - tfsec ./ || true
      - checkov -d ./ || true
      
  post_build:
    commands:
      - echo "üì§ Pushing image to ECR..."
      - docker tag netflix-app:$TAG ${ECR_REPO}:$TAG
      - docker push ${ECR_REPO}:$TAG

      - echo "üöÄ Deploying to EKS cluster..."
      - **aws eks update-kubeconfig --region $AWS_REGION --name $EKS_CLUSTER**

      # S·ª≠a t√™n deployment v√† container name cho ƒë√∫ng (gi·∫£ ƒë·ªãnh t√™n deployment l√† netflix-app)
      - **kubectl set image deployment/netflix-app netflix-container=${ECR_REPO}:$TAG**
      - **kubectl rollout status deployment/netflix-app**
artifacts:
  files:
    - '**/*'
